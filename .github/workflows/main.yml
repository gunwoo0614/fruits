name: Fix choice[] only then Build

on: push

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3

      - name: Validate & Patch choice[] words (choice-body only)
        shell: pwsh
        run: |
          $valid = @("Apple","Banana","Orange","Grape","Peach")
          $replacement = "Apple"
          $file = "main.c"

          $code = Get-Content -LiteralPath $file -Raw -Encoding UTF8

          # Find the choice[] initializer region: choice[] = { ... };
          $pattern = '(?<pre>\bchoice\s*\[\s*\]\s*=\s*\{)(?<body>[\s\S]*?)(?<post>\}\s*;)'
          $m = [regex]::Match($code, $pattern, [System.Text.RegularExpressions.RegexOptions]::Singleline)

          if (-not $m.Success) {
            Write-Host "ERROR: choice[] initializer not found in ${file}"
            exit 1
          }

          $body = $m.Groups['body'].Value

          # Extract only the string literals inside the choice[] body
          $choices = [regex]::Matches($body, '"([^"\\]*(\\.[^"\\]*)*)"') | ForEach-Object { $_.Groups[1].Value }

          $invalid = @()
          foreach ($c in $choices) {
            if ($valid -notcontains $c) { $invalid += $c }
          }

          if ($invalid.Count -gt 0) {
            $invalidUnique = $invalid | Select-Object -Unique
            Write-Host "Invalid choice words found in choice[]: $($invalidUnique -join ', ')"

            # Patch ONLY inside the body (not the whole file)
            $newBody = $body
            foreach ($bad in $invalidUnique) {
              $escaped = [regex]::Escape($bad)
              $newBody = [regex]::Replace($newBody, '"' + $escaped + '"', '"' + $replacement + '"')
            }

            # Rebuild code by replacing only the matched choice[] initializer region
            $before = $code.Substring(0, $m.Index)
            $after  = $code.Substring($m.Index + $m.Length)
            $newCode = $before + $m.Groups['pre'].Value + $newBody + $m.Groups['post'].Value + $after

            Set-Content -LiteralPath $file -Value $newCode -NoNewline -Encoding UTF8
            Write-Host "Patched ${file}: replaced invalid words with '$replacement' (choice[] body only)"
          } else {
            Write-Host "All choice[] words are valid. No patch needed."
          }

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build
        run: cl /nologo /W4 /EHsc main.c /Fe:main.exe

      - name: Run
        run: .\main.exe
